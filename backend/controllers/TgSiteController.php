<?php/** * Sistema per la gestione del sito web */namespace backend\controllers;use Yii;use yii\filters\VerbFilter;use yii\filters\AccessControl;use yii\web\Controller;use yii\db\Query;use yii\web\Response;use yii\web\JsonResponseFormatter;use backend\models\Posts;use backend\models\Postmeta;/** * Site controller */class TgSiteController extends Controller{    /**     * {@inheritdoc}     */    public function behaviors()    {        return [            'access' => [                'class' => AccessControl::className(),                'rules' => [                    [                        'actions' => ['login', 'error'],                        'allow' => true,                    ],                    [                        'actions' => [],//All page                        'allow' => true,                        //'roles' => ['Super User','segreteria'],                    ],                ],            ],            'verbs' => [                'class' => VerbFilter::className(),                'actions' => [                    'logout' => ['post'],                ],            ],        ];    }        /**     * {@inheritdoc}     */    public function actions()    {        return [            'error' => [                'class' => 'yii\web\ErrorAction',            ],        ];    }    /**     * Displays homepage.     *     * @return string     */    public function actionIndex()    {        return $this->render("index");    }        public function actionMenu(){        $menu   = $this->findMenu();        $posts  = $this->findPosts();                return $this->render("menu",[            'menu'      => $menu,            'posts'     => $posts,            //'menu_type' => json_encode($menu_type),            //'menu_type' => json_encode(Postmeta::$menu_info),            'menu_type' => Postmeta::$menu_info,        ]);    }        /**     * Get Ajax request to save menu     * @return json     */    public function actionMenuSaveAjax()    {        /*Yii::$app->response->format = Response::FORMAT_JSON;        Yii::$app->response->formatters = [            Response::FORMAT_JSON => [                'class' => JsonResponseFormatter::class,                'prettyPrint' => true            ]        ];*/                /*if (Yii::$app->request->isPost) {            print_r(Yii::$app->request->post());        }*/                /*if(($data=Yii::$app->request->post('data'))!==null){            $test = $data['test'];            // do your query stuff here        }else{            $test = "Ajax failed";            // do your query stuff here        }        $test = Yii::$app->request->post();*/                // Imposta il formato della risposta su JSON        Yii::$app->response->format = Response::FORMAT_JSON;        // Verifica se la richiesta è di tipo POST e se è una richiesta Ajax        if (Yii::$app->request->isPost && Yii::$app->request->isAjax) {            // Ottieni i dati POST            //$data = Yii::$app->request->post();             $data = $_POST;                        // Esegui la logica di elaborazione (es. salvare nel database)            // ...                        // Restituisci una risposta JSON            return [                'success' => true,                'message' => 'Dati ricevuti con successo!',                'data' => $data,            ];        } else {            // Gestisci casi in cui la richiesta non è valida            return [                'success' => false,                'message' => 'Richiesta non valida.',            ];        }    }        /**     * Return a menu     *      * Select usata     * SELECT             p.ID,             p.post_title AS item_title,             p.ordering,            pm_url.meta_value AS item_url,            t.name,            (SELECT CONCAT(GROUP_CONCAT(meta_key SEPARATOR '||'), '-', GROUP_CONCAT(meta_value SEPARATOR '||')) FROM tg_postmeta as pm_url_s WHERE pm_url_s.post_id = pm_url.post_id)        FROM             tg_posts AS p        JOIN             tg_term_relationships AS tr ON p.ID = tr.object_id        JOIN             tg_term_taxonomy AS tt ON tr.term_taxonomy_id = tt.term_id        JOIN             tg_terms AS t ON tt.term_id = t.id        LEFT JOIN             tg_postmeta AS pm_url ON p.ID = pm_url.post_id AND pm_url.meta_key = '_menu_item_url'        WHERE             p.post_type = 'nav_menu_item'            AND tt.taxonomy = 'nav_menu'            AND t.name = 'Menu Principale'        ORDER BY             p.ordering ASC     *      * @return \yii\db\ActiveRecord     */    private function findMenu(){        $query = (new Query())            ->select([                'id' => 'p.ID',                'p.post_title',                 'p.ordering',                'pm_url.meta_value',                't.name',                'key_value' => "(SELECT CONCAT(GROUP_CONCAT(meta_key SEPARATOR '||'), '-', GROUP_CONCAT(meta_value SEPARATOR '||')) FROM tg_postmeta as pm_url_s WHERE pm_url_s.post_id = pm_url.post_id)"            ])            ->from(['p' => 'tg_posts'])            ->join("JOIN", "tg_term_relationships tr", "p.ID = tr.object_id")            ->join("JOIN", "tg_term_taxonomy tt", "tr.term_taxonomy_id = tt.term_id")            ->join("JOIN", "tg_terms t", "tt.term_id = t.id")            ->join("JOIN", "tg_postmeta pm_url", "p.ID = pm_url.post_id AND pm_url.meta_key = '_menu_item_url'")            ->where([                'p.post_type' => 'nav_menu_item',                'tt.taxonomy' => 'nav_menu',                't.name'      => 'Menu Principale'            ])            ->orderBy(['p.ordering' => SORT_ASC])            ->all();                foreach ($query as $k => $q){            $q['key_value'] = [                'meta_key'   => explode("||", substr($q['key_value'], 0, strpos($q['key_value'], "-"))),                'meta_value' => explode("||", substr($q['key_value'], strpos($q['key_value'], "-")+1)),            ];                        $query[$k] = $q;        }                return $query;    }        /**     * Find all post     * @return type     * @throws NotFoundHttpException     */    private function findPosts(){        if (($model = Posts::find()->where(['post_type' => 'post'])->all()) !== null) {            return $model;        }                throw new NotFoundHttpException(Yii::t('app', 'The requested page does not exist.'));    }}