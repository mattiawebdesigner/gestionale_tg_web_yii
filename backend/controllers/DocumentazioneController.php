<?phpnamespace backend\controllers;use Yii;use backend\models\Documentazione;use yii\web\Controller;use yii\web\NotFoundHttpException;use yii\web\UploadedFile;use yii\filters\AccessControl;use yii\filters\VerbFilter;use backend\models\DocumentiUploadForm;use backend\models\DocumentazioneCategorie;/** * DocumentazioneController implements the CRUD actions for Documentazione model. */class DocumentazioneController extends Controller{    /**     * @inheritDoc     */    public function behaviors()    {        return array_merge(            parent::behaviors(),            [                'verbs' => [                    'class' => VerbFilter::className(),                    'actions' => [                        'delete' => ['POST'],                    ],                ],                'access' => [                    'class' => AccessControl::className(),                    'rules' => [                        [                            'actions' => ['login', 'error'],                            'allow' => true,                        ],                        [                            'actions' => [],//All page                            'allow' => true,                            'roles' => ['Super User', 'Socio'],                        ],                    ],                ],            ]        );    }    /**     * Lists all Documentazione models.     * @return mixed     */    public function actionIndex($socio = 0)    {                if($socio == 1){            return $this->redirect(['socio-view']);        }                //Le cartelle altro non sono che le categorie di un documento        $cartelle = DocumentazioneCategorie::find()->where(["<>", "categoria", "Nessuna categoria"])->andWhere(['parent' => 1])->all();        $documenti = Documentazione::find()->where(['categoria' => 1])->all();                return $this->render('index', [            'cartelle'  => $cartelle,            'documenti' => $documenti,        ]);    }        /**     * Visualizza il contenuto di una categoria     *      * @param int $id Cartella in cui ci troviamo (suo ID)     * @param int $socio Indica se la pagina da visualizzare Ã¨ dell'amministratore (1) o del socio (0)     * @return mixed     */    public function actionFolder($id, $socio = 0){        $documenti      = Documentazione::find()->where(['categoria' => $id])->all();        $cartella       = DocumentazioneCategorie::findOne($id);        $sottoCartelle  = DocumentazioneCategorie::find()->where(['parent' => $id])->all();        //Utilizzato per il pulsante "indietro" (usato per tornare alla directory precedente)        $bid            = $cartella->parent;                return $this->render('folder', [            'id'            => $id,            'bid'           => $bid,            'documenti'     => $documenti,            'cartella_obj'  => $cartella,            'socio'         => $socio,            'sottoCartelle' => $sottoCartelle,        ]);    }        /**     * Cancella un file     *      * @param int $id File da cancellare     */    public function actionDeleteFile($id, $cartella_id = 1){        $file_da_eliminare = Documentazione::findOne($id);                unset($file_da_eliminare->link);//Cancella il documento dal server                $file_da_eliminare->delete();//Rimuove la cartella                Yii::$app->session->setFlash('success', Yii::t('app', 'File cancellato con successo'));        return $this->redirect(['folder',             'id' => $cartella_id,        ]);    }        /**     * Crea una nuova cartella.     * Utilizzato da Ajax     */    public function actionCreateFolder(){                if(Yii::$app->request->post('nomeCartellla')){            $cartella = new DocumentazioneCategorie();            $cartella->categoria = Yii::$app->request->post('nomeCartellla');                        if($cartella->save()){                return true;            }else{                return false;            }        }                return false;    }        /**     * Cancella una categoria e tutti i documenti ad essa associati.     * I documenti vengono anche fisicamente cancellati dal server.     *      * @param type $id     */    public function actionDeleteFolder($id){        $cartella           = DocumentazioneCategorie::findOne($id);        $file_da_eliminare  = Documentazione::find()->where(['categoria' => $id])->all();        $bid                = $cartella->parent;                foreach ($file_da_eliminare as $file){            unset($file->link);//Cancella il documento dal server        }                $cartella->delete();//Rimuove la cartella                Yii::$app->session->setFlash('success', Yii::t('app', 'Cartella cancellata con successo'));                if($bid == 1){            return $this->redirect(['index', 'id' => $id]);        }else{            return $this->redirect(['folder', 'id' => $bid]);        }    }    /**     * Visualizza un documento caricato e ne permette il download     *      * @param int $id Codice del documento     * @return mixed     * @throws NotFoundHttpException if the model cannot be found     */    public function actionView($id, $cartellaId, $socio = 0)    {        return $this->render('view', [            'model'      => $this->findModel($id),            'cartellaId' => $cartellaId,            'socio'      => $socio,        ]);    }        /**     * Carica un nuovo documento     *      * @param int $id Codice della categoria     * @return mixed     */    public function actionUpload($id)    {        $model = new Documentazione();        $upload = new DocumentiUploadForm();                if ($this->request->isPost) {            if ($model->load($this->request->post()) /*&& $model->save()*/) {                //Upload file                $upload->mediaFile = UploadedFile::getInstance($upload, 'mediaFile');                if( $mediafile = $upload->upload()){                    $model->mime = $mediafile['type'];                    $model->link = dirname(dirname(dirname(Yii::$app->getHomeUrl())))                                    . DIRECTORY_SEPARATOR                                    . "backend".DIRECTORY_SEPARATOR                                    . "web"                                    . DIRECTORY_SEPARATOR                                    . $mediafile['uploadDirectory']                                    . $mediafile['fileName']                                    . "."                                    .$mediafile['extension'];                    //Save the data                                        if($model->save()){                        return $this->redirect(['folder', 'id' => $id]);                    }                }            }        } else {            $model->loadDefaultValues();        }                return $this->render('create', [            'model'  => $model,            'upload' => $upload,            'id'     => $id,        ]);    }    /**     * Updates an existing Documentazione model.     * If update is successful, the browser will be redirected to the 'view' page.     * @param int $id ID     * @return mixed     * @throws NotFoundHttpException if the model cannot be found     */    /*public function actionUpdate($id)    {        $model = $this->findModel($id);        $upload = new DocumentiUploadForm();        if ($this->request->isPost && $model->load($this->request->post())) {            if ($model->load($this->request->post()) /*&& $model->save()*//*) {                //Upload file                $upload->mediaFile = UploadedFile::getInstance($upload, 'mediaFile');                if( $mediafile = $upload->upload()){                    $model->mime = $mediafile['type'];                    $model->link = dirname(dirname(dirname(Yii::$app->getHomeUrl())))                    . DIRECTORY_SEPARATOR                    . "backend".DIRECTORY_SEPARATOR                    . "web"                        . DIRECTORY_SEPARATOR                        . $mediafile['uploadDirectory']                        . $mediafile['fileName']                        . "."                            .$mediafile['extension'];                            //Save the data                            if($model->save()) return $this->redirect(['view', 'id' => $model->id]);                }            }        }        return $this->render('update', [            'model'  => $model,            'upload' => $upload,         ]);    }*/        /**     * Deletes an existing Documentazione model.     * If deletion is successful, the browser will be redirected to the 'index' page.     * @param int $id ID     * @return mixed     * @throws NotFoundHttpException if the model cannot be found     */    public function actionDelete($id)    {        $this->findModel($id)->delete();                return $this->redirect(['index']);    }        /**     * Show single document for the user     *     * @return mixed     */    public function actionSingleView($id){        $model = Documentazione::find()->where(['id' => $id])->one();               return $this->render('singleView', [            'model' => $model,        ]);    }        /*PAGINE PER I SOCI*/    public function actionCategorySocioAll($cat_id){        $docs = Documentazione::find()->where(['documentazione_categoria_id' => $cat_id])->all();        return $this->render("category-socio-all", [            'docs' => $docs,        ]);    }    /**     * Show all document's for the user     *     * @return mixed     */    public function actionSocioView(){                //Le cartelle altro non sono che le categorie di un documento        $cartelle = DocumentazioneCategorie::find()->where(["<>", "categoria", "Nessuna categoria"])->andWhere(['parent' => 1])->all();        $documenti = Documentazione::find()->where(['categoria' => 1])->all();                return $this->render("index-socio", [            'cartelle'  => $cartelle,            'documenti' => $documenti,        ]);            }    /*----------------------------------------------------------------------------------------------------------------*/        /**     * Finds the Documentazione model based on its primary key value.     * If the model is not found, a 404 HTTP exception will be thrown.     * @param int $id ID     * @return Documentazione the loaded model     * @throws NotFoundHttpException if the model cannot be found     */    protected function findModel($id)    {        if (($model = Documentazione::findOne($id)) !== null) {            return $model;        }                throw new NotFoundHttpException(Yii::t('app', 'The requested page does not exist.'));    }}