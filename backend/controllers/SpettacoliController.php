<?php/** * Controller per la gestione degli spettacoli teatrali della compagnia. *  * Questa sezione Ã¨ utile per gestire le prenotazioni con piantina degli  * spettacoli. *  * @author Mattia Leonardo Angelillo * @date 2024-09-14 */namespace backend\controllers;use Yii;use yii\filters\VerbFilter;use yii\filters\AccessControl;use yii\web\Controller;use yii\web\UploadedFile;use yii\web\NotFoundHttpException;use backend\models\Spettacoli;use backend\models\SpettacoliSearch;use backend\models\IltTeatroPiantina;use backend\components\sistema_prenotazione_biglietti\Postazioni;use backend\models\SpettacoloPrenotazione;/** * Site controller */class SpettacoliController extends Controller{    /**     * {@inheritdoc}     */    public function behaviors()    {        return [            'access' => [                'class' => AccessControl::className(),                'rules' => [                    [                        'actions' => ['login', 'error','login-by-app', 'reset-password', 'nuova-password'],                        'allow' => true,                    ],                    [                        'actions' => ['logout', 'index'],                        'allow' => true,                        'roles' => ['@'],                    ],                    [                        'actions' => [],//All page                        'allow' => true,                        'roles' => ['Super User', 'spettacoli'],                    ],                ],            ],            'verbs' => [                'class' => VerbFilter::className(),                'actions' => [                    'logout' => ['post'],                ],            ],        ];    }        /**     * {@inheritdoc}     */    public function actions()    {        return [            'error' => [                'class' => 'yii\web\ErrorAction',            ],        ];    }    /**     * Displays homepage.     *     * @return string     */    public function actionIndex()    {        $searchModel = new SpettacoliSearch();        $dataProvider = $searchModel->search($this->request->queryParams);                return $this->render("index", [            'searchModel'  => $searchModel,            'dataProvider' => $dataProvider,        ]);    }        /**     * Permette l'inserimento di un nuovo spettacolo     *      * @return mixed     */    public function actionCreate(){        $model = new Spettacoli();        $piantine = IltTeatroPiantina::find()->all();                if(Yii::$app->request->isPost){                        if($model->load(Yii::$app->request->post())){                $piantina                   = \backend\models\IltTeatroPiantina::findOne($model->piantina);                $model->piantina            = $piantina->piantina;                $model->backgroundPiantina  = $piantina->background;                $model->backgroundPosition  = $piantina->position;                                $banner = UploadedFile::getInstance($model, 'banner');                if($banner <> ""){                    $filename = md5($banner->baseName).md5(date('YmdHmi')). '.' . $banner->extension;                                        //$banner->saveAs("iloveteatro/pdf_uploads/".$filename);                    $model->banner = Yii::$app->params['site_protocol'].Yii::$app->params['backendWeb']                                            .DIRECTORY_SEPARATOR.Yii::$app->params['crm_upload_path']. $filename;                    $banner->saveAs(Yii::$app->params['crm_upload_path'].$filename);                }                                $locandina = UploadedFile::getInstance($model, 'locandina');                                if($locandina <> ""){                    $filename = md5($banner->baseName).md5(date('YmdHmi')). '.' . $banner->extension;                    $model->locandina = Yii::$app->params['site_protocol'].Yii::$app->params['backendWeb']                                            .Yii::$app->params['crm_upload_path']. $filename;                    $locandina->saveAs(Yii::$app->params['crm_upload_path'].$filename);                }                                if($model->save()){                    return $this->redirect(['view-show', 'id' => $model->id]);                }            }        }                return $this->render('create', [            'model'     => $model,            'piantine'  => $piantine,        ]);    }        /**     *      * @param type $id     * @return typeVisualizza i dettagli dello spettacolo e ne consente      * la modifica     *      * @param $id ID dello spettacolo     */    public function actionViewShow($id){        $model = $this->findModelSpettacolo($id);        $oldLocandina = $model->locandina;        $oldBanner = $model->banner;        if(Yii::$app->request->isPost){            if($model->load(Yii::$app->request->post())){                $model->banner = $oldBanner;                $model->locandina = $oldLocandina;                $banner = UploadedFile::getInstance($model, 'banner');                if($banner <> ""){                    $filename = md5($banner->baseName).md5(date('YmdHmi')). '.' . $banner->extension;                    //$banner->saveAs("iloveteatro/pdf_uploads/".$filename);                    $model->banner = Yii::$app->params['site_protocol'].Yii::$app->params['backendWeb']                                            .DIRECTORY_SEPARATOR.Yii::$app->params['crm_upload_path']. $filename;                    $banner->saveAs(Yii::$app->params['crm_upload_path'].$filename);                }else{                }                                $locandina = UploadedFile::getInstance($model, 'locandina');                if($locandina <> ""){                    $filename = md5($locandina->baseName).md5(date('YmdHmi')). '.' . $locandina->extension;                    $model->locandina = Yii::$app->params['site_protocol'].Yii::$app->params['backendWeb']                                            .Yii::$app->params['crm_upload_path']. $filename;                    $locandina->saveAs(Yii::$app->params['crm_upload_path'].$filename);                }                if($model->save()){                    return $this->redirect(['view-show', 'id' => $id]);                }            }        }        return $this->render('show', [            'model' => $model,        ]);    }        /**     * Cancella uno spettacolo     *      * @param int $id ID dello spettacolo da eliminare     * @return type     */    public function actionDelete($id){        $model = $this->findModelSpettacolo($id);                //Cancello le immagini dal server        $img = substr($model->banner, strpos($model->banner, Yii::$app->params['crm_upload_path']));        if(file_exists($img)){            unlink(substr($model->banner, strpos($model->banner, Yii::$app->params['crm_upload_path'])));        }        $img = substr($model->locandina, strpos($model->locandina, Yii::$app->params['crm_upload_path']));        if(file_exists($img)){            unlink($img);        }        //Cancello lo spettacolo        $model->delete();                Yii::$app->session->setFlash('success', Yii::t('app', 'Spettacolo rimosso con successo dalla programmazione'));        return $this->redirect(['/spettacoli/index']);            }        /**     * Effettua una nuova prenotazione per lo spettacolo     *      * @param type $spettacolo_id     */    public function actionPrenotazioneTicket($spettacolo_id){        $model = $this->findModelSpettacolo($spettacolo_id);        $postazioni = new Postazioni(json_decode($model->piantina));                if(Yii::$app->request->isPost){            $dati         = Yii::$app->request->post("dati");            $prenotazione = Yii::$app->request->post("prenotazione");                        $prenotazione_esistente = SpettacoloPrenotazione::find()->where(['email' => $dati['email'], 'spettacolo' => $spettacolo_id])->one();                        $res_prenotazioni = $postazioni->prenotazione(                $prenotazione,                !is_null($prenotazione_esistente)?json_decode($prenotazione_esistente->prenotazione, true):null,                Yii::$app->request->post('tipo-prenotazione')??SpettacoloPrenotazione::NON_PAGATO            );                        //Salvo i dati della prenotazione            $model->piantina = $res_prenotazioni['piantina'];            $model->save();                        if(!is_null($prenotazione_esistente)){                $prenotazione_esistente->prenotazione = $res_prenotazioni['prenotazione_posti_utente'];                $prenotazione_esistente->save();            }else{//creo una nuova prenotazione                $nuova_prenotazione_obj = new SpettacoloPrenotazione();                $nuova_prenotazione_obj->nome       = $dati['nome'];                $nuova_prenotazione_obj->cognome    = $dati['cognome'];                $nuova_prenotazione_obj->email      = $dati['email'];                $nuova_prenotazione_obj->cellulare  = $dati['cellulare'];                $nuova_prenotazione_obj->spettacolo = $spettacolo_id;                $nuova_prenotazione_obj->prenotazione = $res_prenotazioni['prenotazione_posti_utente'];                $nuova_prenotazione_obj->save();               }                        //Fine salvataggio dei dati            Yii::$app->session->setFlash('success', Yii::t('app', 'Prenotazione salvata con successo'));            return $this->redirect(['prenotazione-ticket', 'spettacolo_id' => $spettacolo_id]);        }                return $this->render('nuova-prenotazione', [            'model'         => $model,            'postazioni'    => $postazioni,        ]);    }        /**     * Gestione di tutte le prenotazioni     * per un dato spettacolo     *      * @param int $spettacolo_id     * @param string $search     * @return mixed     */    public function actionPrenotazioni($spettacolo_id, $search = ""){        $prenotazioni = SpettacoloPrenotazione::find()                            ->where(['spettacolo' => $spettacolo_id])                            ->orderBy(['cognome' => SORT_ASC, 'nome' => SORT_ASC, 'data_registrazione' => SORT_ASC])                            ->groupBy(['email'])                            ->all();        $spettacolo = Spettacoli::findOne($spettacolo_id);                //Conto il numero totale di posti prenotati        $totali         = SpettacoloPrenotazione::totali($prenotazioni, $spettacolo->piantina);        $nOfSeatState   = $totali['nOfSeatState'];                //------------------------------------------------------------                if(Yii::$app->request->isPost){            $search = Yii::$app->request->post("cerca");            if($search <> ""){                $prenotazioni = SpettacoloPrenotazione::find()                                ->where(['like', 'nome', "%".$search."%", false])                                ->orWhere(['like', 'cognome', "%".$search."%", false])                                ->orWhere(['like', 'email', "%".$search."%", false])                                ->groupBy(['email'])                                ->andWhere(['spettacolo' => $spettacolo_id])                                ->all();                                return $this->render('prenotazioni', [                    'prenotazioni'  => $prenotazioni,                    'spettacolo'    => $spettacolo,                    'search'        => $search,                    'spettacolo_id' => $spettacolo_id,                                                    'nOfSeatBooked' => SpettacoloPrenotazione::totali($prenotazioni, $spettacolo->piantina)['nOfSeatBooked'],                    'nOfSeatState'  => SpettacoloPrenotazione::totali($prenotazioni, $spettacolo->piantina)['nOfSeatState'],                ]);            }        }                return $this->render('prenotazioni', [            'prenotazioni'  => $prenotazioni,            'spettacolo'    => $spettacolo,            'search'        => $search,            'spettacolo_id' => $spettacolo_id,                        //Totale dei posti occupati            'nOfSeatBooked' => SpettacoloPrenotazione::totali($prenotazioni, $spettacolo->piantina)['nOfSeatBooked'],            //Informazioni sui posti:            //- Pagati            //- Da pagare            //- Posti riservati per la stampa            //- Totali            'nOfSeatState'  => SpettacoloPrenotazione::totali($prenotazioni, $spettacolo->piantina)['nOfSeatState'],        ]);    }        /**     * Visualizza una prenotazione per gestirla.     *      * @param string $email Email usata per la prenotazione     * @param int $spettacolo_id     * @return mixed    */    public function actionShowTicket($email, $spettacolo_id){        $prenotazioni = SpettacoloPrenotazione::find()                            ->where(['email' => $email])                            ->andWhere(['spettacolo' => $spettacolo_id])                            ->orderBy(['cognome' => SORT_ASC, 'nome' => SORT_ASC])                            ->all();        //Seleziono tutte le prenotazioni dello spettacolo        $tutte_le_prenotazioni = \app\models\IltSpettacolo::find()                                ->andWhere('data >= :data', [':data' => date('Y-m-d')])                                ->andWhere(['id' => $spettacolo_id])                                ->orderBy(['data' => SORT_ASC])                                ->all();        $spettacolo = $this->findModelSpettacolo($spettacolo_id);                                if(Yii::$app->request->isPost){            $postazioni             = new Postazioni(json_decode($spettacolo->piantina));            $prenotazioni_da_cancellare = [];                        //Se devo segnare come pagati dei ticket            if(Yii::$app->request->post("reservations-buy") !== null){                $dati                   = Yii::$app->request->post("dati");                $prenotazione           = Yii::$app->request->post("prenotazione");                $subscriptions          = Yii::$app->request->post("subscriptions");                $prenotazione_esistente = SpettacoloPrenotazione::find()->where(['email' => $dati['email'], 'spettacolo' => $spettacolo_id])->one();                                //Gestisco gli abbonamenti                $res_prenotazioni = $postazioni->buy(                    $subscriptions??[],                     $prenotazione_esistente??[]                );                $spettacolo->piantina = $res_prenotazioni['piantina'];                $spettacolo->save();                                //Gestisco i ticket                $res_prenotazioni = $postazioni->buy(                    $prenotazione??[],                     $prenotazione_esistente??[]                );                                $spettacolo->piantina = $res_prenotazioni['piantina'];                $spettacolo->save();                                Yii::$app->session->setFlash('success', Yii::t('app', 'Pagamento registrato'));            }            else{                if(Yii::$app->request->post("reservations-delete") !== null){//Se devo eliminare delle prenotazioni                                        //Cancellazione ticket                    if(!is_null(Yii::$app->request->post('prenotazione'))){                        foreach (Yii::$app->request->post('prenotazione') as $k => $v){                            foreach ($v['nome'] as $key => $prenotazione){                                //Se esiste il palco allora stiamo cancellando il posto di un ordine                                if(isset($v['palco'])){                                    if($v['posto'][$key] <> "non_numerato"){                                        $prenotazioni_da_cancellare[$k]['palco'][$v['palco'][$key]]['file'][$v['fila'][$key]]['posti'][] = $v['posto'][$key];                                    }else{//posti non numerati                                        $prenotazioni_da_cancellare[$k]['palco'][$v['palco'][$key]]['file'][$v['fila'][$key]]['posti'][] = Yii::$app->request->post('nn-place');                                    }                                }else if(isset($v['fila'])){//Stiamo cancellando il posto in platea                                   $prenotazioni_da_cancellare[$k]['file'][$v['fila'][$key]]['posti'][] = $v['posto'][$key];                                }                            }                        }                        //--------------------------------------------------------------------------------------------------------                        $prenotazioni_da_cancellare = json_encode($prenotazioni_da_cancellare);                        $prenotazioni_aggiornate = $postazioni->cancellaPrenotazione($prenotazioni_da_cancellare, $prenotazioni[0]->prenotazione);                        $prenotazioni[0]->prenotazione = json_encode($prenotazioni_aggiornate['prenotazioni']);                        $spettacolo->piantina = json_encode($prenotazioni_aggiornate['posti']);                                                if($prenotazioni[0]->save() && $spettacolo->save()){                           Yii::$app->session->setFlash('success', Yii::t('app', 'Prenotazione cancellata con successo'));                        }                    }                                        //Fine cancellazione ticket                                        Yii::$app->session->setFlash('success', Yii::t('app', 'Prenotazione cancellata con successo'));                                                        }                else{//Se sto inserendo una nuova prenotazione                    $dati                   = Yii::$app->request->post("dati");                    $prenotazione           = Yii::$app->request->post("prenotazione");                    $prenotazione_esistente = SpettacoloPrenotazione::find()->where(['email' => $dati['email'], 'spettacolo' => $spettacolo_id])->one();                                        $res_prenotazioni = $postazioni->prenotazione(                        $prenotazione,                        !is_null($prenotazione_esistente)?json_decode($prenotazione_esistente->prenotazione, true):null                    );                    //Salvo i dati della prenotazione                                        $flag_prenotazione = false;                    if(!is_null($prenotazione_esistente)){                        $prenotazione_esistente->prenotazione = $res_prenotazioni['prenotazione_posti_utente'];                        if($prenotazione_esistente->save()){                            $flag_prenotazione = true;                        }                    }else{//creo una nuova prenotazione                        $nuova_prenotazione_obj = new SpettacoloPrenotazione();                        $nuova_prenotazione_obj->nome       = $dati['nome'];                        $nuova_prenotazione_obj->cognome    = $dati['cognome'];                        $nuova_prenotazione_obj->email      = $dati['email'];                        $nuova_prenotazione_obj->cellulare  = $dati['cellulare'];                        $nuova_prenotazione_obj->spettacolo = $spettacolo_id;                        $nuova_prenotazione_obj->pagato     = SpettacoloPrenotazione::NON_PAGATO;                        $nuova_prenotazione_obj->prenotazione = $res_prenotazioni['prenotazione_posti_utente'];                        if($nuova_prenotazione_obj->save()){                            $flag_prenotazione = true;                        }                                           }                    //Fine salvataggio dei dati                                        if($flag_prenotazione){                        Yii::$app->session->setFlash('success', Yii::t('app', 'Prenotazione salvata con successo!'));                                                //Aggiorno la piantina                        $spettacolo->piantina = $res_prenotazioni['piantina'];                        if(!$spettacolo->save()){                            Yii::$app->session->setFlash('error', Yii::t('app', 'Errore nella prenotazione, contattare un amministratore.'));                        }                    }else{                        Yii::$app->session->setFlash('success', Yii::t('app', 'Errore nella prenotazione, contattare un amministratore.'));                    }                }            }                        return $this->redirect(['show-ticket', 'email' => $email, 'spettacolo_id' => $spettacolo_id]);                    }                $postazioni = new Postazioni(                            json_decode($spettacolo->piantina),                            json_encode(                                array_merge_recursive(                                    json_decode($prenotazioni[0]->prenotazione, true)??[],                                    //json_decode($prenotazioni[0]->abbonamento, true)??[]                                )                            )        );                //Conto il numero totale di posti prenotati        $totali         = SpettacoloPrenotazione::totali($prenotazioni, $spettacolo->piantina);        $nOfSeatState   = $totali['nOfSeatState'];        //------------------------------------------------------------                               return $this->render('show-prenotazione', [            //Dati dello spettacolo            'spettacolo'    => $spettacolo,            //Elenco delle prenotazioni registrate            //Usiamo l'indice 0 perchÃ© esiste un unico riscontro in base all'email            'prenotazioni'  => $prenotazioni[0],            //Mappa del teatro            'postazioni'    => $postazioni,            'email'         => $email,            //Codice dello spettacolo            'spettacolo_id' => $spettacolo_id,            //Tutte le prenotazioni presenti nel sistema per lo spettacolo            'tutte_le_prenotazioni' => $tutte_le_prenotazioni,            //Stato dei posti            'nOfSeatState' => $nOfSeatState,        ]);            }        /**     * Finds the Media model based on its primary key value.     * If the model is not found, a 404 HTTP exception will be thrown.     * @param int $id ID     * @return Media the loaded model     * @throws NotFoundHttpException if the model cannot be found     */    protected function findModelSpettacolo($id)    {        if (($model = Spettacoli::findOne($id)) !== null) {            return $model;        }        throw new NotFoundHttpException(Yii::t('app', 'The requested page does not exist.'));    }}